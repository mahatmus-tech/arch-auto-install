---
- name: Install Hyprland dependencies
  pacman:
    name:
      - ninja
      - gcc
      - cmake
      - meson
      - libxcb
      - xcb-proto
      - xcb-util
      - xcb-util-keysyms
      - libxfixes
      - libx11
      - libxcomposite
      - libxrender
      - libxcursor
      - pixman
      - wayland-protocols
      - cairo
      - pango
      - libxkbcommon
      - xcb-util-wm
      - xorg-xwayland
      - libinput
      - libliftoff
      - libdisplay-info
      - cpio
      - tomlplusplus
      - hyprland-git
      - hyprcursor-git
      - hyprwayland-scanner-git
      - xcb-util-errors
      - hypruilts-git
      - glaze
      - hyprgraphics-git
      - aquamarine-git
      - re2
      - hyprland-qtuilts
    state: present

- name: Install Hyprland
  shell: |
    git clone --recursive https://github.com/hyprwm/Hyprland /tmp/Hyprland
    cd /tmp/Hyprland
    make all && make install
  args:
    creates: /usr/bin/Hyprland

- name: Create monitor configuration directory
  file:
    path: /home/mahatmus/.config/hypr/Monitor_Profiles
    state: directory
    owner: mahatmus
    group: mahatmus
    mode: '0755'

- name: Create 120hz monitor config
  copy:
    dest: /home/mahatmus/.config/hypr/Monitor_Profiles/120hz.conf
    content: |
      # Generated by nwg-displays on 2025-03-24 at 12:02:36. Do not edit manually.
      
      # Não está na wiki, mas para ser o monitor primário ele deve ter a posição 0x0
      # também deixar o monitor primário acima do secundário

      monitor=HDMI-A-1,0x0@60.0,-1x-1,1.0
      monitor=HDMI-A-1,disable
      monitor=DP-3,modeline 336.96 1920 1968 2000 2080 1080 1083 1088 1350 +hsync -vsync, 0x0, 1.0, bitdepth, 8, cm, srgb
      monitor=DP-1,2560x1080@60.0, -2560x0, 1.0
    owner: mahatmus
    group: mahatmus
    mode: '0644'

- name: Create UserConfigs directory
  file:
    path: /home/mahatmus/.config/hypr/UserConfigs
    state: directory
    owner: mahatmus
    group: mahatmus
    mode: '0755'

- name: Configure startup apps
  copy:
    dest: /home/mahatmus/.config/hypr/UserConfigs/Startup_Apps.conf
    content: |
      #Set emacs server to startup with hyprland.
      exec-once = emacs --daemon &
      exec-once = systemctl --user start gamemoded.services
    owner: mahatmus
    group: mahatmus
    mode: '0644'

- name: Configure environment variables
  copy:
    dest: /home/mahatmus/.config/hypr/UserConfigs/ENVariables.conf
    content: |
      # set ambient variable
      file: hyprland.conf
      env = LIBVA_DRIVER_NAME,nvidia
      env = __GLX_VENDOR_LIBRARY_NAME,nvidia
      env = NVD_BACKEND,direct
      env = GBM_BACKEND,nvidia-drm
      env = WLR_RENDERER_ALLOW_SOFTWARE,1
      env = WLR_DRM_DEVICES,/dev/dri/card1
      env = __GL_GSYNC_ALLOWED,0           # Disable G-SYNC in XWayland (can cause stuttering)
      env = __GL_MaxFramesAllowed,1        # Reduce input lag
      env = __GL_SYNC_TO_VBLANK,0          # Disable VSYNC (use in-game limiter instead)
      env = CLUTTER_DEFAULT_FPS,120        # Match your monitor's refresh rate
      env = WLR_DRM_NO_ATOMIC,1            # Avoid atomic modesetting bugs
      #env = __GL_THREADED_OPTIMIZATIONS,1 #  (esta causando BUG, deixa desabilitado!)
    owner: mahatmus
    group: mahatmus
    mode: '0644'